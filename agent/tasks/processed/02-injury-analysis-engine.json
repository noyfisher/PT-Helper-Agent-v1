{
  "type": "ios_feature",
  "mode": "pr",
  "title": "Injury Analysis Engine with Adaptive Questions",
  "description": "Build the core injury analysis engine that takes the user's selected pain locations (from BodyMapView) and their health profile data, asks targeted follow-up questions about each pain area, and produces a differential analysis with the top 3 most likely conditions. The analysis uses a rule-based decision engine (not AI API calls) that cross-references the body region, symptom characteristics, user demographics (age, sex, weight, activity level), medical history, surgical history, and existing injuries to score and rank possible conditions. Each condition includes a confidence percentage, a plain-English explanation of why it was identified, and red-flag warnings if applicable.",
  "requirements": [
    "Create a PainAssessment model: selectedRegion (BodyRegion), painType (enum: sharp, dull, burning, throbbing, aching, stabbing, tingling), painIntensity (Int 1-10), painDuration (enum: today, fewDays, oneToTwoWeeks, twoToFourWeeks, overAMonth, overThreeMonths), painFrequency (enum: constant, intermittent, onlyWithActivity, onlyAtRest, atNight), painOnset (enum: sudden, gradual, afterInjury, afterSurgery, unknown), aggravatingFactors ([String] from a preset list like 'Walking', 'Sitting', 'Lifting', 'Twisting', 'Climbing stairs', 'Running', 'Reaching overhead'), relievingFactors ([String] from preset list like 'Rest', 'Ice', 'Heat', 'Stretching', 'Medication', 'Elevation'), additionalNotes (String optional)",
    "Create a ConditionResult model: conditionName (String), confidence (Double 0-100), explanation (String — 2-3 sentences explaining why this condition was identified, referencing the user's specific symptoms and history), isRedFlag (Bool), redFlagMessage (String? — if red flag, explain why urgent care may be needed), nextSteps ([String] — 3-5 actionable next steps)",
    "Create an AnalysisResult model that holds: assessments ([PainAssessment]), conditions ([ConditionResult] — top 3 ranked by confidence), overallSummary (String — 2-3 sentence plain-English summary), disclaimerText (String — medical disclaimer), generatedDate (Date), userProfileSnapshot (reference to key profile data used)",
    "Create InjuryAnalysisViewModel that orchestrates the entire flow. It takes selectedRegions from BodyMapViewModel and the loaded UserProfile. It manages the current assessment step (one PainAssessment per selected region), and when all regions are assessed, runs the analysis engine to produce the AnalysisResult",
    "Create PainDetailView — a multi-step questionnaire shown after the body map. For EACH selected body region, show a card-based form collecting: pain type (visual selection with SF Symbols — e.g. bolt.fill for sharp, flame.fill for burning), intensity (custom slider with gradient from green to red, showing the number), duration, frequency, onset, aggravating factors (multi-select chips), relieving factors (multi-select chips), and optional notes TextField. Show which region is being assessed (e.g. 'Left Knee — 1 of 3') with a progress indicator",
    "Build the analysis engine as a static function or dedicated class: InjuryAnalyzer.analyze(assessments:profile:) -> AnalysisResult. The engine should have a condition database — a dictionary mapping body region zone keys to arrays of possible conditions. Each condition entry has: name, baseScore, symptom modifiers (e.g. +20 if pain is sharp, +15 if onset was sudden), demographic modifiers (e.g. +10 if age > 50 for arthritis, +15 if athlete for overuse injuries), history modifiers (e.g. +25 if user has previous surgery in same area, +20 if user has arthritis in medical conditions). The engine scores each candidate condition, normalizes to percentages, and returns the top 3",
    "The condition database should include realistic conditions for each body region. Examples — Knee: Patellofemoral Pain Syndrome, Meniscus Tear, ACL Sprain, IT Band Syndrome, Patellar Tendinitis, Osteoarthritis. Shoulder: Rotator Cuff Strain, Impingement Syndrome, Frozen Shoulder, Labral Tear, Bursitis. Back: Herniated Disc, Muscle Strain, Sciatica, Spinal Stenosis, Facet Joint Syndrome. Include at least 4-6 conditions per major body region",
    "Red flag detection: If certain symptom combinations appear (e.g. sudden severe pain + numbness, chest pain + shortness of breath, head injury + confusion), flag the result as a red flag with a clear message recommending immediate medical attention",
    "The PainDetailView must follow the app's design system: Color(.systemGroupedBackground) base, card sections with shadows and rounded corners, SF Symbols for icons, filled blue primary buttons, proper typography hierarchy. Multi-select chips should use the toggle pattern from MedicalHistoryStepView (colored when selected, gray when not). The intensity slider should be a custom view with a gradient track",
    "Include 'Back' and 'Next' navigation between region assessments, and a 'Review & Analyze' button on the last region that triggers the analysis"
  ],
  "deliverables": [
    {
      "path": "ios/PT-Helper/PT-Helper/Models/PainAssessment.swift",
      "type": "new",
      "description": "Data models for PainAssessment (pain characteristics per region), ConditionResult (ranked condition with confidence and explanation), and AnalysisResult (complete analysis output)"
    },
    {
      "path": "ios/PT-Helper/PT-Helper/Models/InjuryAnalyzer.swift",
      "type": "new",
      "description": "Rule-based analysis engine with condition database per body region. Scores candidate conditions using symptom + demographic + history modifiers, returns top 3 with confidence percentages and explanations"
    },
    {
      "path": "ios/PT-Helper/PT-Helper/ViewModels/InjuryAnalysisViewModel.swift",
      "type": "new",
      "description": "ViewModel managing the pain assessment questionnaire flow and analysis execution. Holds assessments array, tracks current region being assessed, triggers InjuryAnalyzer when complete"
    },
    {
      "path": "ios/PT-Helper/PT-Helper/Views/PainDetailView.swift",
      "type": "new",
      "description": "Multi-step pain questionnaire view — for each selected body region, collects pain type, intensity, duration, frequency, onset, aggravating/relieving factors via card-based forms with visual selection"
    }
  ],
  "context_files": [
    "ios/PT-Helper/PT-Helper/Models/BodyRegion.swift",
    "ios/PT-Helper/PT-Helper/Models/UserProfile.swift",
    "ios/PT-Helper/PT-Helper/ViewModels/BodyMapViewModel.swift",
    "ios/PT-Helper/PT-Helper/Views/BodyMapView.swift",
    "ios/PT-Helper/PT-Helper/Views/OnboardingSteps/MedicalHistoryStepView.swift",
    "ios/PT-Helper/PT-Helper/Views/OnboardingSteps/BasicInfoStepView.swift",
    "docs/brief.md"
  ],
  "context": {
    "app_domain": "physical_therapy",
    "target_ios_version": "16.0+",
    "ui_framework": "SwiftUI",
    "architecture_pattern": "MVVM",
    "notes": "This task builds on task 1 (body map). The BodyMapView navigates to PainDetailView, passing selectedRegions and the loaded UserProfile. The InjuryAnalyzer is a pure Swift rule-based engine — it does NOT call any external AI API. It uses a static condition database with scoring modifiers. The analysis must produce human-readable explanations that reference the user's specific data (e.g. 'Given your history of arthritis and the gradual onset of dull pain in your right knee...'). The PainDetailView questionnaire collects one PainAssessment per selected body region, then navigates to the AnalysisResultView (created in task 3). Ensure all enums in PainAssessment are CaseIterable and have a displayName computed property for UI rendering. Use Codable on all models. The Optional<String>.bound extension already exists in MedicalHistoryStepView.swift — do NOT redefine it."
  }
}
